<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>新建网页</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.8.3.min.js"></script>
<meta name="description" content="" />
<style>
*{padding:0; margin:0;font-size:16px;}
   ul,li{padding:0; margin:0;}
   ul,li{list-style:none;}
   a{text-decoration:none;}
   a:hover{text-decoration:none;border: 0} 
#content{width:98%;height:auto;float:left;margin-left:1%;}
#content #content_h{width:100%;height:40px;border:1px solid #D7D7D7;line-height:40px;margin-top:15px}
#content #content_h a{padding-left:10px}
#content #content_m{width:100%;height:auto;border:1px solid #D7D7D7;padding-bottom:100px;margin-top:20px}
#content table{margin:0 auto;margin-top:20px}
#content table td span{float:right}
#content table td .isshow{width:20px;height:20px;float:left;}
input{width:400px;height:24px;border-radius:3px;border-bottom:1px solid #E3E9EF;border-top:1px solid #ABADB3;border-left:1px solid #E2E3EA;border-right:1px solid #DBDFE6}
textarea{width:500px;height:160px;border-radius:3px;border-bottom:1px solid #E3E9EF;border-top:1px solid #ABADB3;border-left:1px solid #E2E3EA;border-right:1px solid #DBDFE6}
td img{max-width:250px}
td{padding-right:30px;padding-top:5px}
table button{border:0px;background:#C43926;color:white;padding:5px;border-radius:2px;float:left;}
.btn_addimg{display:block;width:100px;margin-top:10px;color:white;position:relative;height:28px;line-height:28px;text-align:center;float:left;background:#C43926;border-radius:4px;}
.btn_addimg input{width:100px;position:absolute;left:0;top:0;filter:alpha(opacity=50);-moz-opacity:0;-khtml-opacity:0;opacity:0;}
textarea{outline:none;resize:none;}
.img{width:100px;height:auto;float:left;}
.img img{max-width:100%;max-height:100px;float:left}
.goods_attr{margin-top:5px;}
.btn{display:block;width:100px;margin-top:10px;color:white;position:relative;height:28px;line-height:28px;text-align:center;float:left;background:#C43926;border-radius:4px;}
.checkbox{width:16px;height:16px;float:left;}
.checkbox_text{width:130px;height:18px;float:left;
	white-space:nowrap; 
    text-overflow:ellipsis; 
    -o-text-overflow:ellipsis; 
    overflow: hidden; }
</style>
</head>
<body>          
<div id="content">
     <div id="content_h">
          <a>后台管理中心</a>-><a>商品分类编辑</a>
     </div>
     <div id="content_m">		               
	      <form id='form'>
	            <input type='hidden' name='id' value="{$category['id']}"/>
                <table cellspacing="10">
                      <tr><td><span>上级:</span></td>
                            <td>
                                <select name="pid">
                                     <option value="0">顶级分类</option>
                                     <volist name="categorys" id="v">
                                         <if condition="$v['id'] eq $category['pid']">
                                         <option value="{$v['id']}" style="text-indent:{$v['padding']}" selected>{$v['html']} {$v['cat_name']}</option>
                                         <else/>
                                         <option value="{$v['id']}" style="text-indent:{$v['padding']}">{$v['html']} {$v['cat_name']}</option>
                                         </if>
                                         </volist>

                                </select>
                            </td>
                      </tr>
                      <tr>
                             <td><span>分类名:</span></td>
                             <td>
                             <input type="text" name="cat_name" value="{$category['cat_name']}"></input></td>
                      </tr>                              	                                    
                      <tr>
                          <td valign="top"><span>筛选扩展属性:</span></td>
                          <td>
                              <div class='select'>  
                                  <select class='select_goods_type' name='type_id'>  
                                      <option>请选择商品类型...</option>
                                      <volist name='goods_type' id='v'>  
                                          <if condition="$v['id'] eq $category['type_id']">
                                          <option value="{$v['id']}" style="text-indent:{$v['padding']}" selected>{$v['type_name']}</option>
                                          <else/>
                                          <option value="{$v['id']}" style="text-indent:{$v['padding']}">{$v['type_name']}</option>
                                          </if>
                                      </volist>
                                  </select>
                                  <ul>
                                      <volist name='filter_extendattr' id='v'>
                                          <li class='goods_attr'>{$v['attr_name']}</li>
                                      </volist>
                                  </ul>
                              </div>
                          </td>
                      </tr>
                      </tr>
                          <td valign="top"><span>商品品牌筛选:</span></td>
                          <td>
                              <ul class='brand' style='width:600px'>
                              <volist name='brands' id='v'>
                              <li style="width:150px;float:left;margin-top:6px">
                              <label class='checkbox_text'>{$v['brand_name']}:</label>
                              <in name="v.id" value="$cat_brand">
                              <input type='checkbox' name='brand_id[]' value="{$v['id']}" class='checkbox' checked />
                              <else/>
                              <input type='checkbox' name='brand_id[]' value="{$v['id']}" class='checkbox' />
                              </in>
                              </volist>
                              </li>
                              </ul>
                          </td>
                     </tr> 
                     <tr>
                            <td><span>路由配置:</span></td>
                            <td><input type="text" name="router" value="{$category['router']}"></input></td>
                     </tr>                     
                     <tr>
                            <td><span>排序:</span></td>
                            <td><input type="text" name="sort" value="{$category['sort']}"></input></td>
                     </tr>
                     <tr>
                            <td><span>是否显示:</span></td>
                            <td>
                               <input type="radio" name="status" value="1" checked='checked' class='isshow'></input><p style="height:20px;float:left;line-height:20px">是</p>
                               <input type="radio" name="status" style="margin-left:15px" class='isshow' value="0"></input><p style="height:20px;float:left;line-height:20px;">否</p>
                            </td>
                     </tr>
                     <tr>
                            <td valign="top"><span>分类描述:</span></td>
                            <td>
                               <textarea style="width:500px;height:200px" name="cat_remark">{$category['cat_remark']}</textarea>
                            </td>
                     </tr>
                     <tr>
                            <td valign="top"><span>上传图片(首页):</span></td>
                            <td style="padding-top:0">
                              <div class="img">
                              <img src="__ROOT__{$category['index_thumb']|substr=1}"/>
                                <a class="btn_addimg">点击添加<input type="file" name="index_thumb" onchange='show(this);'></input></a>                                             
                                </div> 
                            </td>
                     </tr>
                     <tr>
                            <td valign="top"><span>上传图片(所有分享商品分类页):</span></td>
                            <td style="padding-top:0">
                            	<div class="img">
                            	<img src="__ROOT__{$category['cat_thumb']|substr=1}"/>
                                <a class="btn_addimg">点击添加<input type="file" name="cat_thumb" onchange='show(this);'></input></a>                                             
                                </div> 
                            </td>
                     </tr>
                     <tr>
	                     <td></td>
	                     <td>
	                         <a class='btn' style="width:100px;" href='javascript:;'>确认保存</a>
	                     </td>
                     </tr>	
                </table>
        </form>
   </div>
</div>
</body>
<script type="text/javascript">  
/*
 * 点击获取商品类型属性
 * */    
$(".select_goods_type").change(function(){
	var _this   = this;
	var type_id = $(".select_goods_type option:selected").val();
	$.post("{:U('Goodstype/getFilterAttr')}",{"type_id":type_id},function(res){
	      var html = getExtendAttrHtml(res);
	      $(".select ul").html(html);
    }); 
})

function getExtendAttrHtml(data){
	var html = [];
    for(var k in data){
    	html.push("<li class='goods_attr'>" + data[k].attr_name);
    	html.push("    <input type='hidden' name='filter_extendattr[]' value='"+ data[k].attr_id + "'>");                               
        html.push("</li>");                                                         
    }
    return html;
}

$(".btn").click(function(){
    request();
})

/*
 * 提交数据
 **/
function request(){  
    var data = new FormData($("#form")[0]);  // 要求使用的html对象
    var url  = "{:U('categoryUpdate')}";
    var url_ = "{:U('categoryList')}"
    $.ajax({  
          url : url ,  
          type: 'POST',  
          data: data,  
          async: true,  
          // 下面三个参数要指定，如果不指定，会报一个JQuery的错误 
　　　　　cache: false,  
          contentType: false,  
          processData: false,  
          success: function (res) {  
          	  alert(res.msg);
          	  console.log(res);
              if(res.status){
                  window.location.href = url_;
              }  
          },  
          error: function (returndata) {  
              console.log(returndata); 
          }  
     });  
}

//上传图片预览
function show(obj){
   var file = obj.files[0];   
   var reader = new FileReader();  
   var _this = this;
   //将文件以Data URL形式读入页面  
   reader.readAsDataURL(file);  
   reader.onload=function(e){ 
   	//显示文件  
    $(obj).parent('.btn_addimg').siblings('img').attr("src",this.result);
   }
} 
</script>
</html>